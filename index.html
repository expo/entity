<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Entity</title>
	<meta name="description" content="Documentation for Entity">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="assets/js/search.json" data-base=".">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="index.html" class="title">Entity</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-externals" checked />
							<label class="tsd-widget" for="tsd-filter-externals">Externals</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="globals.html">Globals</a>
				</li>
			</ul>
			<h1>Entity</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<a href="#entity" id="entity" style="color: inherit; text-decoration: none;">
					<h1>Entity</h1>
				</a>
				<p>Entity is a privacy-aware data layer for defining, caching, and authorizing access to application data models.</p>
				<p><img src="https://github.com/expo/entity/workflows/Tests/badge.svg" alt="Tests">
					<a href="https://codecov.io/gh/expo/entity"><img src="https://codecov.io/gh/expo/entity/branch/master/graph/badge.svg" alt="codecov"></a>
					<a href="https://www.npmjs.com/package/@expo/entity"><img src="https://img.shields.io/npm/v/@expo/entity" alt="npm"></a>
				<a href="https://www.npmjs.com/package/@expo/entity"><img src="https://img.shields.io/npm/l/@expo/entity" alt="NPM"></a></p>
				<a href="#core-features" id="core-features" style="color: inherit; text-decoration: none;">
					<h2>Core Features</h2>
				</a>
				<ul>
					<li>Declarative actor authorization using Privacy Policies</li>
					<li>Configurable data storage using Database Adapters</li>
					<li>Configurable, optional full-object caching using Cache Adapters</li>
					<li><a href="https://github.com/graphql/dataloader">Dataloader</a> in-memory caching</li>
					<li>Well-typed model declaration</li>
				</ul>
				<a href="#getting-started" id="getting-started" style="color: inherit; text-decoration: none;">
					<h2>Getting Started</h2>
				</a>
				<p>The best place get started is by checking out the <a href="packages/entity-example">example application</a>.</p>
				<a href="#background" id="background" style="color: inherit; text-decoration: none;">
					<h2>Background</h2>
				</a>
				<p>Authorization is the process of determining whether a user has access to a piece of data or a feature.</p>
				<p>One could imagine a simple application with users and their photos. The authorization logic is simple: when the user loads their photos, only query photos <code>WHERE user_id = user.id</code>. A more complex authorization system is most likely overkill at this point.</p>
				<p>Now, lets add teams to our simple application, where users on the same team can see each others&#39; photos. The authorization logic becomes more complex: <code>WHERE user_id = user.id OR user_id IN (list of users for all organizations that user belongs to)</code>. While still maintainable, one can see that as requirements are added, this logic becomes increasingly difficult to express in just the query or simple checks in code.</p>
				<p>A common next step is to add an authorization system on top of the data loading layer. <a href="https://github.com/varvet/pundit">Pundit</a>, <a href="https://github.com/dfunckt/django-rules">Django Rules</a>, and <a href="https://laravel.com/docs/authorization">Laravel Policies</a> are examples of excellent libraries that provide a method to authorize a piece of loaded data in the following manner:</p>
				<pre><code>PhotoModel
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authorize_read</span><span class="hljs-params">()</span></span>:
        <span class="hljs-keyword">if</span> rules.is_photo_owner(user, photo)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> rules.has_organization_permission(user, photo)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authorize_create</span><span class="hljs-params">()</span></span>:
        ...

PhotoView
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span><span class="hljs-params">()</span></span>:
        photo = Photo.find(params[<span class="hljs-symbol">:id</span>])
        authorize(photo, <span class="hljs-string">'read'</span>)
        render_html(photo)</code></pre><p>This works well and is flexible since it allows executing ad-hoc authorization checks. Most libraries also provide hooks into views or controllers such that these authorization checks are performed automatically. This is sufficient for many applications but still has one main drawback: it is prone to error in cases where the authorization check is forgotten or the incorrect check is performed.</p>
				<p>The Entity framework solves this by adding an additional property to the system: all data accesses are authorized. Given an <code>object</code> and a <code>viewer</code>, the framework provides a clear and testable mechanism for expressing complex relationships between <code>object</code> and <code>viewer</code> needed to authorize access during CRUD operations, and makes it impossible to perform CRUD operations without performing the authorization checks. This combines the data load and authorization steps from above into a single step:</p>
				<pre><code class="language-typescript"><span class="hljs-keyword">class</span> PhotoPrivacyPolicy {
  <span class="hljs-keyword">const</span> readRules = [
    <span class="hljs-keyword">new</span> AllowIfOwnerRule(),
    <span class="hljs-keyword">new</span> AllowIfOrganizationPermissionRule(),
  ];
}

<span class="hljs-comment">// in the view, for example</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_photo_page</span>(<span class="hljs-params">viewer: ViewerContext</span>): <span class="hljs-title">string</span> </span>{
  <span class="hljs-keyword">const</span> photo = <span class="hljs-keyword">await</span> PhotoEntity.loader(viewer).loadById(id);
  <span class="hljs-keyword">return</span> render_html(photo);
}</code></pre>
				<a href="#use-case" id="use-case" style="color: inherit; text-decoration: none;">
					<h2>Use Case</h2>
				</a>
				<p>Entity is not limited in where it can or should be used, but was designed for use in a <a href="https://koajs.com/">Koa</a>-like environment with a request and response. At Expo, we use Entity in the following manner:</p>
				<ol>
					<li>A request comes into Koa router</li>
					<li>Middleware initializes the Entity framework for the request</li>
					<li>A <code>ViewerContext</code> is created identifying the individual making the request.</li>
					<li>The request fulfiller uses the Entity framework and the <code>ViewerContext</code> to load or mutate some data and return a response.</li>
				</ol>
				<p>Note: The entity framework instance should not be shared across multiple requests since it contains a unique memoized <a href="https://github.com/graphql/dataloader#class-dataloader">Dataloader</a>. A long-lived instance is prone to data synchronization issues, especially when the application is scaled horizontally and multiple shared caches would exist for the same data.</p>
				<a href="#license" id="license" style="color: inherit; text-decoration: none;">
					<h2>License</h2>
				</a>
				<p>The Entity source code is made available under the <a href="LICENSE">MIT license</a>.</p>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="globals  ">
						<a href="globals.html"><em>Globals</em></a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_expo_entity.html">@expo/entity</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_expo_entity_cache_adapter_redis.html">@expo/entity-<wbr>cache-<wbr>adapter-<wbr>redis</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_expo_entity_database_adapter_knex.html">@expo/entity-<wbr>database-<wbr>adapter-<wbr>knex</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li>
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
				<li class="tsd-kind-function tsd-has-type-parameter"><span class="tsd-kind-icon">Function with type parameter</span></li>
				<li class="tsd-kind-type-alias"><span class="tsd-kind-icon">Type alias</span></li>
				<li class="tsd-kind-type-alias tsd-has-type-parameter"><span class="tsd-kind-icon">Type alias with type parameter</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li>
				<li class="tsd-kind-interface tsd-has-type-parameter"><span class="tsd-kind-icon">Interface with type parameter</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-class"><span class="tsd-kind-icon">Class</span></li>
				<li class="tsd-kind-class tsd-has-type-parameter"><span class="tsd-kind-icon">Class with type parameter</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-enum"><span class="tsd-kind-icon">Enumeration</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="assets/js/main.js"></script>
<script>if (location.protocol == 'file:') document.write('<script src="assets/js/search.js"><' + '/script>');</script>
</body>
</html>