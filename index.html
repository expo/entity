<!DOCTYPE html><html class="default" lang="en" data-base="."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Entity</title><meta name="description" content="Documentation for Entity"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script><script async src="assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">Entity</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>Entity</h1></div><div class="tsd-panel tsd-typography"><a id="entity" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Entity<a href="#entity" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Entity is a privacy-aware data layer for defining, caching, and authorizing access to application data models.</p>
<p><a href="https://github.com/expo/entity/actions?query=workflow%3Atests"><img src="https://github.com/expo/entity/workflows/tests/badge.svg" alt="tests"></a>
<a href="https://expo.github.io/entity/"><img src="https://github.com/expo/entity/workflows/docs/badge.svg" alt="docs"></a>
<a href="https://codecov.io/gh/expo/entity"><img src="https://codecov.io/gh/expo/entity/graph/badge.svg?token=4cFAAdINbk" alt="codecov"></a>
<a href="https://www.npmjs.com/package/@expo/entity"><img src="https://img.shields.io/npm/v/@expo/entity" alt="npm"></a>
<a href="https://www.npmjs.com/package/@expo/entity"><img src="https://img.shields.io/npm/l/@expo/entity" alt="NPM"></a></p>
<a id="core-features" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Core Features<a href="#core-features" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Declarative actor authorization using Privacy Policies</li>
<li>Configurable data storage using Database Adapters</li>
<li>Configurable, optional full-object caching using Cache Adapters</li>
<li><a href="https://github.com/graphql/dataloader">Dataloader</a> in-memory caching</li>
<li>Well-typed model declaration</li>
</ul>
<a id="getting-started" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Getting Started<a href="#getting-started" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><a href="https://github.com/expo/entity/tree/main/packages/entity-example">Example application</a></li>
<li><a href="https://expo.github.io/entity/">Documentation</a></li>
</ul>
<a id="background" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Background<a href="#background" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Authorization is the process of determining whether a user has access to a piece of data or a feature.</p>
<p>One could imagine a simple application with users and their photos. The authorization logic is simple: when the user loads their photos, only query photos <code>WHERE user_id = user.id</code>. A more complex authorization system is most likely overkill at this point.</p>
<p>Now, lets add teams to our simple application, where users on the same team can see each others' photos. The authorization logic becomes more complex: <code>WHERE user_id = user.id OR user_id IN (list of users for all organizations that user belongs to)</code>. While still maintainable, one can see that as requirements are added, this logic becomes increasingly difficult to express in just the query or simple checks in code.</p>
<p>A common next step is to add an authorization system on top of the data loading layer. <a href="https://github.com/varvet/pundit">Pundit</a>, <a href="https://github.com/dfunckt/django-rules">Django Rules</a>, and <a href="https://laravel.com/docs/authorization">Laravel Policies</a> are examples of excellent libraries that provide a method to authorize a piece of loaded data in the following manner:</p>
<pre><code><span class="hl-0">PhotoModel</span><br/><span class="hl-1">    </span><span class="hl-0">def</span><span class="hl-1"> </span><span class="hl-2">authorize_read</span><span class="hl-1">():</span><br/><span class="hl-1">        </span><span class="hl-3">if</span><span class="hl-1"> </span><span class="hl-0">rules</span><span class="hl-1">.</span><span class="hl-2">is_photo_owner</span><span class="hl-1">(</span><span class="hl-0">user</span><span class="hl-1">, </span><span class="hl-0">photo</span><span class="hl-1">)</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">true</span><br/><span class="hl-1">        </span><span class="hl-3">if</span><span class="hl-1"> </span><span class="hl-0">rules</span><span class="hl-1">.</span><span class="hl-2">has_organization_permission</span><span class="hl-1">(</span><span class="hl-0">user</span><span class="hl-1">, </span><span class="hl-0">photo</span><span class="hl-1">)</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">true</span><br/><span class="hl-1">    </span><span class="hl-0">def</span><span class="hl-1"> </span><span class="hl-2">authorize_create</span><span class="hl-1">():</span><br/><span class="hl-1">        ...</span><br/><br/><span class="hl-0">PhotoView</span><br/><span class="hl-1">    </span><span class="hl-0">def</span><span class="hl-1"> </span><span class="hl-2">render</span><span class="hl-1">():</span><br/><span class="hl-1">        </span><span class="hl-0">photo</span><span class="hl-1"> = </span><span class="hl-0">Photo</span><span class="hl-1">.</span><span class="hl-2">find</span><span class="hl-1">(</span><span class="hl-0">params</span><span class="hl-1">[:</span><span class="hl-0">id</span><span class="hl-1">])</span><br/><span class="hl-1">        </span><span class="hl-2">authorize</span><span class="hl-1">(</span><span class="hl-0">photo</span><span class="hl-1">, </span><span class="hl-5">&#39;read&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">        </span><span class="hl-2">render_html</span><span class="hl-1">(</span><span class="hl-0">photo</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>This works well and is flexible since it allows executing ad-hoc authorization checks. Most libraries also provide hooks into views or controllers such that these authorization checks are performed automatically. This is sufficient for many applications but still has one main drawback: it is prone to error in cases where the authorization check is forgotten or the incorrect check is performed.</p>
<p>The Entity framework solves this by adding an additional property to the system: all data accesses are authorized. Given an <code>object</code> and a <code>viewer</code>, the framework provides a clear and testable mechanism for expressing complex relationships between <code>object</code> and <code>viewer</code> needed to authorize access during CRUD operations, and makes it impossible to perform CRUD operations without performing the authorization checks. This combines the data load and authorization steps from above into a single step:</p>
<pre><code class="typescript"><span class="hl-4">class</span><span class="hl-1"> </span><span class="hl-6">PhotoPrivacyPolicy</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-0">readRules</span><span class="hl-1"> = [</span><br/><span class="hl-1">    </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-2">AllowIfOwnerRule</span><span class="hl-1">(),</span><br/><span class="hl-1">    </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-2">AllowIfOrganizationPermissionRule</span><span class="hl-1">(),</span><br/><span class="hl-1">  ];</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">// in the view, for example</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-4">function</span><span class="hl-1"> </span><span class="hl-2">get_photo_page</span><span class="hl-1">(</span><span class="hl-0">viewer</span><span class="hl-1">: </span><span class="hl-6">ViewerContext</span><span class="hl-1">): </span><span class="hl-6">string</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">photo</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">PhotoEntity</span><span class="hl-1">.</span><span class="hl-2">loader</span><span class="hl-1">(</span><span class="hl-0">viewer</span><span class="hl-1">).</span><span class="hl-2">loadById</span><span class="hl-1">(</span><span class="hl-0">id</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-2">render_html</span><span class="hl-1">(</span><span class="hl-0">photo</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="use-case" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Use Case<a href="#use-case" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Entity is not limited in where it can or should be used, but was designed for use in a <a href="https://koajs.com/">Koa</a>-like environment with a request and response. At Expo, we use Entity in the following manner:</p>
<ol>
<li>A request comes into Koa router</li>
<li>Middleware initializes the Entity framework for the request</li>
<li>A <code>ViewerContext</code> is created identifying the individual making the request.</li>
<li>The request fulfiller uses the Entity framework and the <code>ViewerContext</code> to load or mutate some data and return a response.</li>
</ol>
<p>Note: The entity framework instance should not be shared across multiple requests since it contains a unique memoized <a href="https://github.com/graphql/dataloader#class-dataloader">Dataloader</a>. A long-lived instance is prone to data synchronization issues, especially when the application is scaled horizontally and multiple shared caches would exist for the same data.</p>
<a id="releasing" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Releasing<a href="#releasing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>To release a new version:</p>
<ol>
<li><code>git checkout main</code></li>
<li><code>yarn lerna publish [patch|minor|major] -- --conventional-commits  --force-publish</code></li>
<li>In GitHub release interface, create a new release from the tag, copy changelog changes to release description.</li>
</ol>
<a id="license" class="tsd-anchor"></a><h2 class="tsd-anchor-link">License<a href="#license" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The Entity source code is made available under the <a href="media/LICENSE">MIT license</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#entity"><span>Entity</span></a><ul><li><a href="#core-features"><span>Core <wbr/>Features</span></a></li><li><a href="#getting-started"><span>Getting <wbr/>Started</span></a></li><li><a href="#background"><span>Background</span></a></li><li><a href="#use-case"><span>Use <wbr/>Case</span></a></li><li><a href="#releasing"><span>Releasing</span></a></li><li><a href="#license"><span>License</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">Entity</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
