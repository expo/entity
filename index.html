<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Entity</title><meta name="description" content="Documentation for Entity"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os"</script><header class="tsd-page-toolbar">
<div class="tsd-toolbar-contents container">
<div class="table-cell" id="tsd-search" data-base=".">
<div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M15.7824 13.833L12.6666 10.7177C12.5259 10.5771 12.3353 10.499 12.1353 10.499H11.6259C12.4884 9.39596 13.001 8.00859 13.001 6.49937C13.001 2.90909 10.0914 0 6.50048 0C2.90959 0 0 2.90909 0 6.49937C0 10.0896 2.90959 12.9987 6.50048 12.9987C8.00996 12.9987 9.39756 12.4863 10.5008 11.6239V12.1332C10.5008 12.3332 10.5789 12.5238 10.7195 12.6644L13.8354 15.7797C14.1292 16.0734 14.6042 16.0734 14.8948 15.7797L15.7793 14.8954C16.0731 14.6017 16.0731 14.1267 15.7824 13.833ZM6.50048 10.499C4.29094 10.499 2.50018 8.71165 2.50018 6.49937C2.50018 4.29021 4.28781 2.49976 6.50048 2.49976C8.71001 2.49976 10.5008 4.28708 10.5008 6.49937C10.5008 8.70852 8.71314 10.499 6.50048 10.499Z" fill="var(--color-text)"></path></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div>
<ul class="results">
<li class="state loading">Preparing search index...</li>
<li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">Entity</a></div>
<div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="7" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="11" width="14" height="2" fill="var(--color-text)"></rect></svg></a></div></div></header>
<div class="container container-main">
<div class="col-8 col-content">
<div class="tsd-page-title">
<h2>Entity</h2></div>
<div class="tsd-panel tsd-typography">
<a href="#entity" id="entity" style="color: inherit; text-decoration: none;">
  <h1>Entity</h1>
</a>
<p>Entity is a privacy-aware data layer for defining, caching, and authorizing access to application data models.</p>
<p><a href="https://github.com/expo/entity/actions?query=workflow%3Atests"><img src="https://github.com/expo/entity/workflows/tests/badge.svg" alt="tests"></a>
<a href="https://expo.github.io/entity/"><img src="https://github.com/expo/entity/workflows/docs/badge.svg" alt="docs"></a>
<a href="https://codecov.io/gh/expo/entity"><img src="https://codecov.io/gh/expo/entity/branch/main/graph/badge.svg" alt="codecov"></a>
<a href="https://www.npmjs.com/package/@expo/entity"><img src="https://img.shields.io/npm/v/@expo/entity" alt="npm"></a>
<a href="https://www.npmjs.com/package/@expo/entity"><img src="https://img.shields.io/npm/l/@expo/entity" alt="NPM"></a></p>

<a href="#core-features" id="core-features" style="color: inherit; text-decoration: none;">
  <h2>Core Features</h2>
</a>
<ul>
<li>Declarative actor authorization using Privacy Policies</li>
<li>Configurable data storage using Database Adapters</li>
<li>Configurable, optional full-object caching using Cache Adapters</li>
<li><a href="https://github.com/graphql/dataloader">Dataloader</a> in-memory caching</li>
<li>Well-typed model declaration</li>
</ul>

<a href="#getting-started" id="getting-started" style="color: inherit; text-decoration: none;">
  <h2>Getting Started</h2>
</a>
<ul>
<li><a href="packages/entity-example">Example application</a></li>
<li><a href="https://expo.github.io/entity/">Documentation</a></li>
</ul>

<a href="#background" id="background" style="color: inherit; text-decoration: none;">
  <h2>Background</h2>
</a>
<p>Authorization is the process of determining whether a user has access to a piece of data or a feature.</p>
<p>One could imagine a simple application with users and their photos. The authorization logic is simple: when the user loads their photos, only query photos <code>WHERE user_id = user.id</code>. A more complex authorization system is most likely overkill at this point.</p>
<p>Now, lets add teams to our simple application, where users on the same team can see each others&#39; photos. The authorization logic becomes more complex: <code>WHERE user_id = user.id OR user_id IN (list of users for all organizations that user belongs to)</code>. While still maintainable, one can see that as requirements are added, this logic becomes increasingly difficult to express in just the query or simple checks in code.</p>
<p>A common next step is to add an authorization system on top of the data loading layer. <a href="https://github.com/varvet/pundit">Pundit</a>, <a href="https://github.com/dfunckt/django-rules">Django Rules</a>, and <a href="https://laravel.com/docs/authorization">Laravel Policies</a> are examples of excellent libraries that provide a method to authorize a piece of loaded data in the following manner:</p>
<pre><code><span class="hl-0">PhotoModel</span><br/><span class="hl-1">    </span><span class="hl-0">def</span><span class="hl-1"> </span><span class="hl-2">authorize_read</span><span class="hl-1">():</span><br/><span class="hl-1">        </span><span class="hl-3">if</span><span class="hl-1"> </span><span class="hl-0">rules</span><span class="hl-1">.</span><span class="hl-2">is_photo_owner</span><span class="hl-1">(</span><span class="hl-0">user</span><span class="hl-1">, </span><span class="hl-0">photo</span><span class="hl-1">)</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">true</span><br/><span class="hl-1">        </span><span class="hl-3">if</span><span class="hl-1"> </span><span class="hl-0">rules</span><span class="hl-1">.</span><span class="hl-2">has_organization_permission</span><span class="hl-1">(</span><span class="hl-0">user</span><span class="hl-1">, </span><span class="hl-0">photo</span><span class="hl-1">)</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">true</span><br/><span class="hl-1">    </span><span class="hl-0">def</span><span class="hl-1"> </span><span class="hl-2">authorize_create</span><span class="hl-1">():</span><br/><span class="hl-1">        ...</span><br/><br/><span class="hl-0">PhotoView</span><br/><span class="hl-1">    </span><span class="hl-0">def</span><span class="hl-1"> </span><span class="hl-2">render</span><span class="hl-1">():</span><br/><span class="hl-1">        </span><span class="hl-0">photo</span><span class="hl-1"> = </span><span class="hl-0">Photo</span><span class="hl-1">.</span><span class="hl-2">find</span><span class="hl-1">(</span><span class="hl-0">params</span><span class="hl-1">[:</span><span class="hl-0">id</span><span class="hl-1">])</span><br/><span class="hl-1">        </span><span class="hl-2">authorize</span><span class="hl-1">(</span><span class="hl-0">photo</span><span class="hl-1">, </span><span class="hl-5">&#39;read&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">        </span><span class="hl-2">render_html</span><span class="hl-1">(</span><span class="hl-0">photo</span><span class="hl-1">)</span>
</code></pre>
<p>This works well and is flexible since it allows executing ad-hoc authorization checks. Most libraries also provide hooks into views or controllers such that these authorization checks are performed automatically. This is sufficient for many applications but still has one main drawback: it is prone to error in cases where the authorization check is forgotten or the incorrect check is performed.</p>
<p>The Entity framework solves this by adding an additional property to the system: all data accesses are authorized. Given an <code>object</code> and a <code>viewer</code>, the framework provides a clear and testable mechanism for expressing complex relationships between <code>object</code> and <code>viewer</code> needed to authorize access during CRUD operations, and makes it impossible to perform CRUD operations without performing the authorization checks. This combines the data load and authorization steps from above into a single step:</p>
<pre><code class="language-typescript"><span class="hl-4">class</span><span class="hl-1"> </span><span class="hl-6">PhotoPrivacyPolicy</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-0">readRules</span><span class="hl-1"> = [</span><br/><span class="hl-1">    </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-2">AllowIfOwnerRule</span><span class="hl-1">(),</span><br/><span class="hl-1">    </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-2">AllowIfOrganizationPermissionRule</span><span class="hl-1">(),</span><br/><span class="hl-1">  ];</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">// in the view, for example</span><br/><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-4">function</span><span class="hl-1"> </span><span class="hl-2">get_photo_page</span><span class="hl-1">(</span><span class="hl-0">viewer</span><span class="hl-1">: </span><span class="hl-6">ViewerContext</span><span class="hl-1">): </span><span class="hl-6">string</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-8">photo</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">PhotoEntity</span><span class="hl-1">.</span><span class="hl-2">loader</span><span class="hl-1">(</span><span class="hl-0">viewer</span><span class="hl-1">).</span><span class="hl-2">loadById</span><span class="hl-1">(</span><span class="hl-0">id</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-2">render_html</span><span class="hl-1">(</span><span class="hl-0">photo</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#use-case" id="use-case" style="color: inherit; text-decoration: none;">
  <h2>Use Case</h2>
</a>
<p>Entity is not limited in where it can or should be used, but was designed for use in a <a href="https://koajs.com/">Koa</a>-like environment with a request and response. At Expo, we use Entity in the following manner:</p>
<ol>
<li>A request comes into Koa router</li>
<li>Middleware initializes the Entity framework for the request</li>
<li>A <code>ViewerContext</code> is created identifying the individual making the request.</li>
<li>The request fulfiller uses the Entity framework and the <code>ViewerContext</code> to load or mutate some data and return a response.</li>
</ol>
<p>Note: The entity framework instance should not be shared across multiple requests since it contains a unique memoized <a href="https://github.com/graphql/dataloader#class-dataloader">Dataloader</a>. A long-lived instance is prone to data synchronization issues, especially when the application is scaled horizontally and multiple shared caches would exist for the same data.</p>

<a href="#releasing" id="releasing" style="color: inherit; text-decoration: none;">
  <h2>Releasing</h2>
</a>
<p>To release a new version, let&#39;s say <code>v1.0.0</code> for example:</p>
<ol>
<li><code>git checkout -b bump-v1.0.0</code></li>
<li><code>yarn lerna version [patch|minor|major] -- --no-push --conventional-commits</code></li>
<li><code>git push -u origin bump-v1.0.0</code></li>
<li>Create a PR from the <code>bump-v1.0.0</code> branch, wait for tests, and commit the PR using GitHub interface.</li>
<li><code>git checkout main &amp;&amp; git pull</code></li>
<li><code>git tag -d v1.0.0</code></li>
<li><code>git tag v1.0.0</code></li>
<li><code>git push origin v1.0.0</code></li>
<li>In GitHub release interface, create a new release from the tag, copy changelog changes to release description.</li>
<li><code>yarn clean &amp;&amp; yarn tsc</code></li>
<li>In each public subpackage, run <code>npm publish</code> and enter 2FA token.</li>
</ol>

<a href="#license" id="license" style="color: inherit; text-decoration: none;">
  <h2>License</h2>
</a>
<p>The Entity source code is made available under the <a href="LICENSE">MIT license</a>.</p>
</div></div>
<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
<div class="tsd-navigation settings">
<details class="tsd-index-accordion"><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Settings</h3></summary>
<div class="tsd-accordion-details">
<div class="tsd-filter-visibility">
<h4 class="uppercase">Member Visibility</h4><form>
<ul id="tsd-filter-options">
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-private" name="private"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Private</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></form></div>
<div class="tsd-theme-toggle">
<h4 class="uppercase">Theme</h4><select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div>
<nav class="tsd-navigation primary">
<details class="tsd-index-accordion" open><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Modules</h3></summary>
<div class="tsd-accordion-details">
<ul>
<li class="current selected"><a href="modules.html">Entity</a>
<ul>
<li class="tsd-kind-module"><a href="modules/_expo_entity.html">@expo/entity</a></li>
<li class="tsd-kind-module"><a href="modules/_expo_entity_cache_adapter_redis.html">@expo/entity-<wbr/>cache-<wbr/>adapter-<wbr/>redis</a></li>
<li class="tsd-kind-module"><a href="modules/_expo_entity_database_adapter_knex.html">@expo/entity-<wbr/>database-<wbr/>adapter-<wbr/>knex</a></li></ul></li></ul></div></details></nav></div></div>
<div class="container tsd-generator">
<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div>
<div class="overlay"></div><script src="assets/main.js"></script></body></html>